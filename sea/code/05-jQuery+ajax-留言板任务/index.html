<html>
    <head>
        <meta charset="utf-8">
        <title>留言板任务</title>
        <style>
            #submitMessageArea {
                display:block;
            }
            #inputName {
                margin-bottom:10px;
            }
            #messageContent{
                border:1px solid red;
                width:auto;
                height:auto;
                margin-top:50px;
                margin-bottom:50px;
            }
        </style>
        <script src="./js/jquery.js"></script>
        <script>
            //自增函数，标识id，开始为0
            var messageId = 0;
            // 时间戳转时间函数
            function timestampToTime(timestamp) {
                let date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
                let Y = date.getFullYear() + '-';
                let M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
                let D = (date.getDate() < 10 ? '0'+date.getDate() : date.getDate()) + ' ';
                let h = (date.getHours() < 10 ? '0'+date.getHours() : date.getHours()) + ':';
                let m = (date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes()) + ':';
                let s = (date.getSeconds() < 10 ? '0'+date.getSeconds() : date.getSeconds());
                return Y+M+D+h+m+s;
            }
            // 获取当前时间
            function currentTime(){
                var date = (Date.parse(new Date()) / 1000);
                return date;
            }
            $(function(){
                requestServer();
                // 提交留言按钮函数
                $("#submit").click(function(){
                    var data = {};
                    data["name"] = $("#inputNameTag").val();
                    data["content"] = $("#submitMessageTag").val();
                    data["time"] = currentTime().toString();
                    if(data["name"].length==0){
                        alert("姓名不能为空！");
                        return false;
                    }
                    if(data["content"].length==0){
                        alert("内容不能为空！");
                        return false;}
                    // ajax post发送json数据
                    $.ajax({
                        type: "POST",
                        url: "/text.json",
                        contentType: "application/json;charset=utf-8",
                        dataType:"json",
                        data:JSON.stringify(data),
                        success:function(){
                            console.log("提交成功");
                            // alert("留言成功！");
                            // 请求成功时加载最新一条的数据,并清空输入框
                            requestServerNew()
                            $("#inputNameTag").val("");
                            $("#submitMessageTag").val("");
                        },
                        error:function(){
                            console.log("提交失败");
                        }
                    })
                })
                // 绑定删除的函数
                $("body").on("click",".deleteMessage",function(event){
                    var data = {};
                    data["deleteId"] = event.currentTarget.id;
                    $.ajax({
                        type: "POST",
                        url: "/text.json",
                        contentType: "application/json;charset=utf-8",
                        data:JSON.stringify(data),
                        success:function(){
                            console.log("请求成功");
                        },
                        error:function(){
                            console.log("请求失败");
                        }
                    })
                    console.log(event.currentTarget.id);
                });
                // 请求服务端，并把结果输出到dom,加载全部的数据
                function requestServer(){
                    // 将请求到的json字符串转换为json对象，并循环输出到dom上。
                    var messageData;
                    $.get("/text.json",function(data){
                        messageData = jQuery.parseJSON(data);
                        console.log(messageData);
                        for(let i=0; i<messageData.message.length;i++){
                            let messageName = messageData.message[i].name;
                            let messageContent = messageData.message[i].content;
                            let messageTime = timestampToTime(messageData.message[i].time);
                            //使用es6模板字符串，省去一大部分操作。
                            $("#messageContent").append(`
                                姓名: ${messageName}<br>内容: ${messageContent}<br>时间: ${messageTime}<br>
                                <button class='replyMessage'>回复</button>
                                <button class='deleteMessage' id=${messageId}>删除</button><br><br><br>
                            `);
                            messageId++;//每生成一个留言。id自增1，给留言标序
                        }
                    });
                }
                // 请求服务端，（获取最新数据）
                function requestServerNew(){
                    var messageData;
                    $.get("./text.json",function(data){
                        messageData = $.parseJSON(data);
                        // console.log(messageData.message);
                        // 获取最新的值
                        var newValue = messageData.message.length-1;
                        console.log(messageData.message[newValue]);
                        let messageName = messageData.message[newValue].name;
                        let messageContent = messageData.message[newValue].content;
                        let messageTime = timestampToTime(messageData.message[newValue].time);
                        $("#messageContent").append(`
                            姓名: ${messageName}<br>内容: ${messageContent}<br>时间: ${messageTime}<br>
                            <button class='replyMessage'>回复</button>
                            <button class='deleteMessage' id=${messageId}>删除</button><br><br><br>
                        `);
                        messageId++;//每生成一个留言。id自增1，给留言标序
                    })
                }
            })
        </script>
    </head>
    <body>
    <h1>留言板</h1>
    <div id="messageContent">
        <ul>

        </ul>
    </div>
    <div id="inputName">
        <input type="text" placeholder="请输入你的名字" id="inputNameTag">
    </div>
    <div id="submitMessageArea">
        <textarea cols="30" rows="10" id="submitMessageTag"></textarea>
        <button id="submit">提交留言</button>
    </div>
    </body>
</html>